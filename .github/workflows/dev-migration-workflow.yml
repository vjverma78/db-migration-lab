name: Dev Environment Migration

on:
  workflow_dispatch:
    inputs:
      migration_phase:
        description: "Which phase to run (schema, data, full)"
        required: true
        default: "full"
        type: choice
        options:
          - schema
          - data
          - full

jobs:
  dev-migration:
    name: Dev Environment Migration
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: "Y"
          MSSQL_SA_PASSWORD: "MigrationLab123!"
          MSSQL_PID: "Developer"
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"MigrationLab123!\" -Q \"SELECT 1\" -b -C || exit 1"
          --health-interval 15s
          --health-timeout 10s
          --health-retries 40

      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: "MigrationLab123!"
          POSTGRES_DB: migration_target
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 15

    env:
      ENVIRONMENT: dev
      PYTHON_VERSION: "3.10"
      PYTHONPATH: migration/python
      SRC_SQLSERVER_CONN_STR: >
        Driver={ODBC Driver 18 for SQL Server};
        Server=localhost,1433;
        Database=AdventureWorksLite;
        Uid=sa;
        Pwd=MigrationLab123!;
        Encrypt=yes;
        TrustServerCertificate=yes;
      TGT_POSTGRES_CONN_STR: >
        host=localhost port=5432 dbname=migration_target user=postgres password=MigrationLab123!

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            unixodbc-dev \
            libpq-dev \
            gcc \
            g++ \
            make \
            curl \
            apt-transport-https \
            gnupg

      - name: Install Microsoft ODBC Driver 18
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/debian/12/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 mssql-tools18
          echo 'export PATH="$PATH:/opt/mssql-tools18/bin"' >> $GITHUB_ENV

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Wait for databases
        run: |
          echo "Waiting for SQL Server and Postgres to be ready..."
          sleep 40

      # ============================
      # Schema phase (Postgres)
      # ============================
      - name: Apply Postgres schema (SCT output)
        if: github.event.inputs.migration_phase == 'schema' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Applying SCT-generated DDL to PostgreSQL..."
          python migration/python/run_migrations.py \
            --env dev \
            --phase schema \
            --source migration/sct-output

      - name: Apply Postgres schema (manual fixes)
        if: github.event.inputs.migration_phase == 'schema' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Applying manual schema fixes to PostgreSQL..."
          python migration/python/run_migrations.py \
            --env dev \
            --phase schema \
            --source migration/manual-fixes

      - name: Run schema tests
        if: github.event.inputs.migration_phase == 'schema' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Running schema tests against target Postgres..."
          python tests/test_schema.py

      # ============================
      # Data phase (SQL Server + bulk load)
      # ============================
      - name: Initialize SQL Server from init.sql and seed-data.sql
        if: github.event.inputs.migration_phase == 'data' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Creating and initializing AdventureWorksLite from SQL scripts..."
          /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P "MigrationLab123!" -C -d master \
            -i databases/sqlserver/init.sql

          /opt/mssql-tools18/bin/sqlcmd \
            -S localhost -U sa -P "MigrationLab123!" -C -d AdventureWorksLite \
            -i databases/sqlserver/seed-data.sql

      - name: Run Bulk Migration
        if: github.event.inputs.migration_phase == 'data' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Running bulk migration SQL Server -> PostgreSQL..."
          python migration/python/bulk_migrate.py

      # ============================
      # Validation + report
      # ============================
      - name: Run data validation
        if: github.event.inputs.migration_phase == 'data' || github.event.inputs.migration_phase == 'full'
        run: |
          echo "Running migration validation..."
          python migration/python/validate_migration.py

      - name: Write validation report
        if: github.event.inputs.migration_phase == 'data' || github.event.inputs.migration_phase == 'full'
        run: |
          python - << 'EOF'
          import json
          from datetime import datetime

          report = {
              "environment": "dev",
              "timestamp": datetime.now().isoformat(),
              "phase": "${{ github.event.inputs.migration_phase }}",
              "status": "completed"
          }

          with open("validation-report.json", "w") as f:
              json.dump(report, f, indent=2)

          print("Report saved to validation-report.json")
          EOF

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-dev
          path: validation-report.json
